{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/20190727_001/","result":{"data":{"site":{"siteMetadata":{"disqusShortname":"","subtitle":"web系の技術について紹介します","title":"kon-shou's blog","url":"https://blog.kon-shou.com"}},"markdownRemark":{"id":"e69ee9bd-31cc-5d49-9ad6-3dc351b416af","html":"<ol start=\"0\">\n<li><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"#%E5%AF%BE%E8%B1%A1%E8%AA%AD%E8%80%85\">対象読者</a></li>\n<li><a href=\"#%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E7%B0%A1%E5%8D%98%E3%81%AA%E7%B4%B9%E4%BB%8B\">ツールの簡単な紹介</a></li>\n<li><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E3%81%AE%E6%B5%81%E3%82%8C\">ビルドの流れ</a></li>\n<li><a href=\"#bootstrap\">bootstrap</a></li>\n<li><a href=\"#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%AE%9F%E8%A1%8C\">クエリの実行</a></li>\n<li><a href=\"#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB\">さいごに</a></li>\n</ol>\n<h2 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h2>\n<p>自分はGatsbyでブログを書いてるのですが、技術的に気になる点があったので調査しました</p>\n<ul>\n<li>「Gatsbyでのビルドってどういう流れなの？」</li>\n<li>「GatsbyにおけるGraphQLのスキーマってどうなってるの？」</li>\n<li>「GatsbyにおけるGraphQLのクエリ実行ってどうなってるの？」</li>\n</ul>\n<p>みたいなことが気になったので、Gatsbyのコードの流れを追ってみました。</p>\n<p>なお本記事で扱う Gatsby のバージョンは <code class=\"language-text\">2.13.41</code> です。</p>\n<h2 id=\"対象読者\" style=\"position:relative;\"><a href=\"#%E5%AF%BE%E8%B1%A1%E8%AA%AD%E8%80%85\" aria-label=\"対象読者 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>対象読者</h2>\n<ul>\n<li>Gatsbyのことはなんとなく知ってる人</li>\n<li>GraphQLのことをぼんやり知ってる人</li>\n</ul>\n<h2 id=\"ツールの簡単な紹介\" style=\"position:relative;\"><a href=\"#%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E7%B0%A1%E5%8D%98%E3%81%AA%E7%B4%B9%E4%BB%8B\" aria-label=\"ツールの簡単な紹介 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ツールの簡単な紹介</h2>\n<h3 id=\"gatsby-とは\" style=\"position:relative;\"><a href=\"#gatsby-%E3%81%A8%E3%81%AF\" aria-label=\"gatsby とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gatsby とは</h3>\n<p>react で書ける静的サイトジェネレータです。</p>\n<p>特徴としては</p>\n<ul>\n<li>view が react で書ける</li>\n<li>コンポーネントにデータを GraphQL で持ってこれる</li>\n<li>plugin でだいたい何でもできる</li>\n</ul>\n<p>みたいなものが有ります。</p>\n<p>ちなみに、Gatsbyでのサイト作成の流れとしては</p>\n<ol>\n<li>お気に入りのスターターテンプレートを見つけて git pull</li>\n<li>そのスターターテンプレートに plugin を加える</li>\n<li>markdown で自身のコンテンツを記述する</li>\n<li><code class=\"language-text\">gatsby develop</code> で出力してみて、内容チェック</li>\n<li>デプロイ</li>\n</ol>\n<p>みたいな流れです。</p>\n<h3 id=\"graphql-とは\" style=\"position:relative;\"><a href=\"#graphql-%E3%81%A8%E3%81%AF\" aria-label=\"graphql とは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GraphQL とは</h3>\n<p>これは</p>\n<ul>\n<li><a href=\"https://graphql.org/\">https://graphql.org/</a></li>\n<li><a href=\"https://employment.en-japan.com/engineerhub/entry/2018/12/26/103000\">https://employment.en-japan.com/engineerhub/entry/2018/12/26/103000</a></li>\n<li><a href=\"https://www.webprofessional.jp/rest-2-0-graphql/\">https://www.webprofessional.jp/rest-2-0-graphql/</a></li>\n</ul>\n<p>等の資料を参考いただければ、分かりやすいかと思います。</p>\n<p>ただ、どうも調べると Gatsbyでの利用と一般的(?)な利用とでは下記の点で異なるようです。</p>\n<ul>\n<li>Gatsbyの場合は、自分でスキーマを用意しないで良い</li>\n<li>Gatsbyの場合は、「GraphQLのクエリ」から「データ取得ロジック」に変換するGraphQLサーバーに相当するものが無い</li>\n</ul>\n<p>これはどういうことなんでしょうか？\n実際にコードを追いましょう。</p>\n<h2 id=\"ビルドの流れ\" style=\"position:relative;\"><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E3%81%AE%E6%B5%81%E3%82%8C\" aria-label=\"ビルドの流れ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ビルドの流れ</h2>\n<p>ビルドの流れを追うためには <a href=\"https://github.com/gatsbyjs/gatsby\">https://github.com/gatsbyjs/gatsby</a> からプルするのが良いかと思います。</p>\n<p><code class=\"language-text\">gatsby develop</code> をすると <code class=\"language-text\">gatsby-cli</code> を経て <code class=\"language-text\">gatsby/dist/commands/develop</code> に飛びます。</p>\n<p>それを抜粋したのが下記になります。</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/commands/develop.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">program<span class=\"token operator\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  \n  <span class=\"token comment\">// 略</span>\n  \n  program<span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">detectPortInUseAndPrompt</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span> rlInterface<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// Start bootstrap process.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> graphqlRunner <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">bootstrap</span><span class=\"token punctuation\">(</span>program<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Start the createPages hot reloader.</span>\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">../bootstrap/page-hot-reloader</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>graphqlRunner<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> queryIds <span class=\"token operator\">=</span> queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">calcInitialDirtyQueryIds</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> staticQueryIds<span class=\"token punctuation\">,</span> pageQueryIds <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">groupQueryIds</span><span class=\"token punctuation\">(</span>queryIds<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">let</span> activity <span class=\"token operator\">=</span> report<span class=\"token punctuation\">.</span><span class=\"token function\">activityTimer</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">run static queries</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">processStaticQueries</span><span class=\"token punctuation\">(</span>staticQueryIds<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    activity<span class=\"token punctuation\">,</span>\n    state<span class=\"token operator\">:</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  activity <span class=\"token operator\">=</span> report<span class=\"token punctuation\">.</span><span class=\"token function\">activityTimer</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">run page queries</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">processPageQueries</span><span class=\"token punctuation\">(</span>pageQueryIds<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> activity <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">../redux/actions</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>boundActionCreators<span class=\"token punctuation\">.</span><span class=\"token function\">setProgramStatus</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">BOOTSTRAP_QUERY_RUNNING_FINISHED</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">await</span> <span class=\"token function\">waitJobsFinished</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  requiresWriter<span class=\"token punctuation\">.</span><span class=\"token function\">startListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  db<span class=\"token punctuation\">.</span><span class=\"token function\">startAutosave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">startListening</span><span class=\"token punctuation\">(</span>queryQueue<span class=\"token punctuation\">.</span><span class=\"token function\">createDevelopQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  queryWatcher<span class=\"token punctuation\">.</span><span class=\"token function\">startWatchDeletePage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>compiler<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">startServer</span><span class=\"token punctuation\">(</span>program<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 略</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここでの大まかな流れは下記です</p>\n<ol>\n<li>bootstrap の処理</li>\n<li>クエリ（ static query と page query ）の実行</li>\n<li>2の結果を元に、htmlの生成</li>\n</ol>\n<p>です。\nここで bootstrap という新しい言葉が出たので、それを先に見ましょう。</p>\n<h2 id=\"bootstrap\" style=\"position:relative;\"><a href=\"#bootstrap\" aria-label=\"bootstrap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>bootstrap</h2>\n<p>bootstrap プロセスはこのファイルです。\n<code class=\"language-text\">https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby/src/bootstrap/index.js</code></p>\n<p>このbootstrapプロセスでは <code class=\"language-text\">activity.start</code> / <code class=\"language-text\">activity.end</code> という単位で多くの処理を実行しています。</p>\n<p>この activity は react コンポーネントのライフサイクルと同じイメージで捉えたら分かりやすいと思います。</p>\n<p>この activityの一つとして </p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/bootstrap/index.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token comment\">// Create Schema.</span>\n  activity <span class=\"token operator\">=</span> report<span class=\"token punctuation\">.</span><span class=\"token function\">activityTimer</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">building schema</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    parentSpan<span class=\"token operator\">:</span> bootstrapSpan<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">../schema</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> parentSpan<span class=\"token operator\">:</span> activity<span class=\"token punctuation\">.</span>span <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>というのがあり、ここでスキーマのビルドを行っています。\nこれが最終的にどうなるかというと、下記のようになります。</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/schema/schema.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">buildSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    schemaComposer<span class=\"token punctuation\">,</span>\n    nodeStore<span class=\"token punctuation\">,</span>\n    types<span class=\"token operator\">:</span> sortedTypes<span class=\"token punctuation\">,</span>\n    fieldExtensions<span class=\"token punctuation\">,</span>\n    thirdPartySchemas<span class=\"token punctuation\">,</span>\n    typeMapping<span class=\"token punctuation\">,</span>\n    typeConflictReporter<span class=\"token punctuation\">,</span>\n    parentSpan<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 略</span>\n\n  store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">SET_SCHEMA</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    payload<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>詳細な説明を省くのですが、これは実際のデータからスキーマを生成し、それをreduxに格納しています。</p>\n<h2 id=\"クエリの実行\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%AE%9F%E8%A1%8C\" aria-label=\"クエリの実行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クエリの実行</h2>\n<p>では、クエリの実行はいつなのかですが、これはbootstrap処理が終わった後です</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/commands/develop.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  activity <span class=\"token operator\">=</span> report<span class=\"token punctuation\">.</span><span class=\"token function\">activityTimer</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">run page queries</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> queryUtil<span class=\"token punctuation\">.</span><span class=\"token function\">processPageQueries</span><span class=\"token punctuation\">(</span>pageQueryIds<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> activity <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  activity<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>この <code class=\"language-text\">processPageQueries()</code> でクエリ実行をしているのですが、これは何をやってるのでしょうか？</p>\n<p>これまた説明を色々と省略するのですが、</p>\n<ol>\n<li>graphql実行をhandlerとして持つQueueを生成</li>\n<li>そのQueueにクエリを格納＆クエリ実行</li>\n</ol>\n<p>という手順でクエリを実行しています。</p>\n<p>Queueの作成はこんな感じです</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/query/queue.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createBuildQueue</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryJob<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    <span class=\"token function\">queryRunner</span><span class=\"token punctuation\">(</span>queryJob<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">,</span> <span class=\"token function\">createBaseOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>handlerとしてのクエリ実行はこんな感じです</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/query/query-runner.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Run query</span>\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">queryJob<span class=\"token operator\">:</span> QueryJob</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> schema<span class=\"token punctuation\">,</span> program<span class=\"token punctuation\">,</span> webpackCompilationHash <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">graphql</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">query<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    <span class=\"token function\">graphqlFunction</span><span class=\"token punctuation\">(</span>\n      schema<span class=\"token punctuation\">,</span>\n      query<span class=\"token punctuation\">,</span>\n      context<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">withResolverContext</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> schema<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      context\n    <span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Run query</span>\n  <span class=\"token keyword\">let</span> result\n  <span class=\"token comment\">// Nothing to do if the query doesn't exist.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>queryJob<span class=\"token punctuation\">.</span>query <span class=\"token operator\">||</span> queryJob<span class=\"token punctuation\">.</span>query <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">graphql</span><span class=\"token punctuation\">(</span>queryJob<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">,</span> queryJob<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 略</span>\n\n  <span class=\"token keyword\">const</span> resultJSON <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">outputFile</span><span class=\"token punctuation\">(</span>resultPath<span class=\"token punctuation\">,</span> resultJSON<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>かなり省いてますが、クエリ実行の流れはこんな感じです。\nクエリ実行した結果を json ファイルとして出力しています。</p>\n<p>そして最後に 静的サイトの出力はどうなっているかですが、これは</p>\n<div class=\"gatsby-code-title\">packages/gatsby/src/commands/develop.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>compiler<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">startServer</span><span class=\"token punctuation\">(</span>program<span class=\"token punctuation\">)</span></code></pre></div>\n<p>で行われます。\nここでクエリにもとづいたjsonからHTMLを描写します。</p>\n<h2 id=\"さいごに\" style=\"position:relative;\"><a href=\"#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB\" aria-label=\"さいごに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>さいごに</h2>\n<p>記事の冒頭に書いた疑問のQ＆Aを書いて〆ようかと思います。</p>\n<p>Q. Gatsbyでのビルドってどういう流れなの？</p>\n<p>A. <code class=\"language-text\">gatsby/dist/commands/develop</code> に書いてある。</p>\n<p>Q. GatsbyにおけるGraphQLのスキーマってどうなってるの？</p>\n<p>A. 実際のデータからスキーマを生成してる。そのスキーマはreduxに置かれてる。</p>\n<p>Q. GatsbyにおけるGraphQLのクエリ実行ってどうなってるの？</p>\n<p>A. ビルド中にスキーマを元にクエリ実行して、結果をjsonとして出力してる</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://graphql.org/\">https://graphql.org/</a></li>\n<li><a href=\"https://employment.en-japan.com/engineerhub/entry/2018/12/26/103000\">https://employment.en-japan.com/engineerhub/entry/2018/12/26/103000</a></li>\n<li><a href=\"https://www.webprofessional.jp/rest-2-0-graphql/\">https://www.webprofessional.jp/rest-2-0-graphql/</a></li>\n<li><a href=\"https://www.gatsbyjs.org/docs/gatsby-lifecycle-apis/\">https://www.gatsbyjs.org/docs/gatsby-lifecycle-apis/</a></li>\n<li><a href=\"https://www.narative.co/articles/understanding-the-gatsby-lifecycle\">https://www.narative.co/articles/understanding-the-gatsby-lifecycle</a></li>\n<li><a href=\"https://gist.github.com/sw-yx/09306ec03df7b4cd8e7469bb74c078fb\">https://gist.github.com/sw-yx/09306ec03df7b4cd8e7469bb74c078fb</a></li>\n</ul>","fields":{"slug":"/posts/20190727/","tagSlugs":["/tag/java-script/","/tag/gatsby/","/tag/graph-ql/"]},"frontmatter":{"date":"2019-07-27","tags":["JavaScript","Gatsby","GraphQL"],"title":"Gatsbyのビルドをザックリ理解","description":"Gatsbyがどういう仕組みで静的ファイルを出力するのかまとめました。","image":{"children":[{"__typename":"ImageSharp","fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHTlaBA8P/EABoQAQABBQAAAAAAAAAAAAAAAAIDAAESEyD/2gAIAQEAAQUCLky2SUWr8f/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAAEFAQAAAAAAAAAAAAAAAAABAiAhMjP/2gAIAQEABj8CdRzUxD//xAAaEAEAAgMBAAAAAAAAAAAAAAABABEhMVEg/9oACAEBAAE/IUklAwTBue3Adyuvj//aAAwDAQACAAMAAAAQu8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QXZ//xAAdEAEBAAIBBQAAAAAAAAAAAAABEQAhIDFBUaHB/9oACAEBAAE/EEJBYTfYuQkIHoA+NX1cWqtRBNwfvD//2Q==","aspectRatio":2,"src":"/static/d99e7aee4c3a832c7f28762cd0657377/14b42/gatsby.jpg","srcSet":"/static/d99e7aee4c3a832c7f28762cd0657377/f836f/gatsby.jpg 200w,\n/static/d99e7aee4c3a832c7f28762cd0657377/2244e/gatsby.jpg 400w,\n/static/d99e7aee4c3a832c7f28762cd0657377/14b42/gatsby.jpg 800w,\n/static/d99e7aee4c3a832c7f28762cd0657377/a7715/gatsby.jpg 1000w","sizes":"(max-width: 800px) 100vw, 800px"}}],"publicURL":"/static/d99e7aee4c3a832c7f28762cd0657377/gatsby.jpeg"}}}},"pageContext":{"slug":"/posts/20190727/"}},"staticQueryHashes":["1155056556","1525128060","783282510"]}